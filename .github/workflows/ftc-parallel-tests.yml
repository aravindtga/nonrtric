name: FTC Suite-policy-all Tests (Standard)

on:
  workflow_dispatch:
    inputs:
      test_env_file:
        description: 'Test environment file to use'
        required: true
        default: '../common/test_env-oran-m-release.sh'
        type: choice
        options:
          - '../common/test_env-oran-m-release.sh'
          - '../common/test_env-oran-l-release.sh'
          - '../common/test_env-oran-k-release.sh'
          - '../common/test_env-onap-paris.sh'
          - '../common/test_env-onap-oslo.sh'
          - '../common/test_env-onap-montreal.sh'
          - '../common/test_env-onap-newdelhi.sh'
      execution_mode:
        description: 'Execution mode'
        required: true
        default: 'remote docker'
        type: choice
        options:
          - 'remote docker'
          - 'remote-remove docker'

jobs:
  # Matrix strategy to run all FTC tests in parallel with isolated environments
  # Each test gets its own GitHub runner instance for complete Docker isolation
  ftc-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 420  # 7 hours timeout for long-running tests
    strategy:
      fail-fast: false  # Continue other tests even if one fails
      max-parallel: 8  # Each test runs on separate runner instance for Docker isolation
      matrix:
        test_case: [
          'FTC1',              # Basic sanity test (from Suite-policy-all.sh)
          'FTC10',             # Basic API test (from Suite-policy-all.sh)
          'FTC110',            # Basic API test (from Suite-policy-all.sh)
          'FTC150',            # Basic config test (from Suite-policy-all.sh)
          'FTC300',            # Config changes (from Suite-policy-all.sh)
          'FTC310',            # Config sync (from Suite-policy-all.sh)
          'FTC350',            # Config test (from Suite-policy-all.sh)
          'FTC850'             # Stability test (from Suite-policy-all.sh)
        ]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          curl \
          jq \
          netcat-openbsd \
          uuid-runtime \
          bc \
          python3-pip \
          python3-venv

    - name: Install Python dependencies
      run: |
        python3 -m pip install --upgrade pip
        python3 -m pip install requests pyyaml

    - name: Set up Docker
      uses: docker/setup-buildx-action@v3

    - name: Install Docker Compose v2
      run: |
        # Remove any existing docker-compose
        sudo rm -f /usr/local/bin/docker-compose
        
        # Install Docker Compose v2.29.7 (latest v2.x)
        sudo curl -L "https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        sudo chmod +x /usr/local/bin/docker-compose
        
        # Verify version
        docker-compose --version
        
        # Ensure it's v2.x
        if ! docker-compose --version | grep -q "v2\."; then
          echo "ERROR: Docker Compose v2.x is required but $(docker-compose --version) is installed"
          exit 1
        fi

    - name: Clean up Docker environment for isolation
      run: |
        # Aggressive cleanup to ensure complete isolation
        docker ps -aq | xargs -r docker rm -f || true
        docker images -q | xargs -r docker rmi -f || true
        docker network ls -q --filter type=custom | xargs -r docker network rm || true
        docker volume ls -q | xargs -r docker volume rm || true
        docker system prune -af --volumes || true
        
        # Clean up any leftover mounted directories with permission issues
        sudo rm -rf test/simulator-group/*/mnt 2>/dev/null || true
        sudo rm -f test/simulator-group/*/*.log 2>/dev/null || true
        
        # Reset Docker daemon to clean state
        sudo systemctl restart docker
        sleep 10
        
        # Verify clean state
        echo "=== Docker Environment Status ==="
        docker ps -a
        docker images
        docker network ls
        docker volume ls

    - name: Set up test environment variables
      run: |
        # Create unique identifiers for this test instance
        TEST_INSTANCE_ID="${{ matrix.test_case }}-$(date +%s)-$$"
        echo "TEST_CASE=${{ matrix.test_case }}" >> $GITHUB_ENV
        echo "TEST_INSTANCE_ID=${TEST_INSTANCE_ID}" >> $GITHUB_ENV
        echo "EXECUTION_MODE=${{ github.event.inputs.execution_mode }}" >> $GITHUB_ENV
        echo "TEST_ENV_FILE=${{ github.event.inputs.test_env_file }}" >> $GITHUB_ENV
        echo "WORKSPACE_PATH=${{ github.workspace }}" >> $GITHUB_ENV
        
        # Set unique container prefix to avoid conflicts
        echo "CONTAINER_PREFIX=gh-${{ matrix.test_case }}-$(echo $GITHUB_RUN_ID | tail -c 6)" >> $GITHUB_ENV

    - name: Create logs directory and fix permissions
      run: |
        mkdir -p ${{ github.workspace }}/test/auto-test/logs/${{ matrix.test_case }}
        
        # Ensure proper permissions for simulator directories
        sudo chown -R $USER:$USER test/simulator-group/ || true
        sudo chmod -R 755 test/simulator-group/ || true
        
        # Create mnt directories that the test framework expects to exist
        find test/simulator-group -maxdepth 1 -type d -name "*" -exec mkdir -p {}/mnt \; 2>/dev/null || true
        chmod -R 777 test/simulator-group/*/mnt 2>/dev/null || true

    - name: Run FTC Test - ${{ matrix.test_case }}
      working-directory: test/auto-test
      run: |
        # Set executable permissions
        chmod +x ./${{ matrix.test_case }}.sh
        chmod +x ../common/*.sh
        
        # Export container prefix for test isolation
        export RICSIM_PREFIX="${CONTAINER_PREFIX}"
        export DOCKER_COMPOSE_PROJECT_NAME="${CONTAINER_PREFIX}"
        
        # Run the test and capture exit code
        set +e  # Don't exit on error, we want to handle it
        timeout 6h ./${{ matrix.test_case }}.sh ${{ github.event.inputs.execution_mode }} --env-file ${{ github.event.inputs.test_env_file }} --print-stats --gen-stats --endpoint-stats 2>&1 | tee test_output.log
        TEST_EXIT_CODE=${PIPESTATUS[0]}
        set -e  # Re-enable exit on error
        
        # Check FTC framework result file as well
        FTC_RESULT_FILE=".result${{ matrix.test_case }}.txt"
        if [ -f "$FTC_RESULT_FILE" ]; then
          FTC_RESULT=$(cat "$FTC_RESULT_FILE")
          echo "FTC result file content: $FTC_RESULT"
        fi
        
        # Determine test result and set environment variable
        if [ $TEST_EXIT_CODE -eq 0 ]; then
          # Double-check with FTC result file if it exists
          if [ -f "$FTC_RESULT_FILE" ] && [ "$FTC_RESULT" != "0" ]; then
            echo "TEST_RESULT=FAIL" >> $GITHUB_ENV
            echo "❌ Test ${{ matrix.test_case }} FAILED (exit code 0 but FTC result: $FTC_RESULT)"
            exit 1
          else
            echo "TEST_RESULT=PASS" >> $GITHUB_ENV
            echo "✅ Test ${{ matrix.test_case }} PASSED"
          fi
        elif [ $TEST_EXIT_CODE -eq 124 ]; then
          echo "TEST_RESULT=TIMEOUT" >> $GITHUB_ENV
          echo "⏰ Test ${{ matrix.test_case }} TIMED OUT after 6 hours"
          exit 1  # Fail the workflow step
        else
          echo "TEST_RESULT=FAIL" >> $GITHUB_ENV
          echo "❌ Test ${{ matrix.test_case }} FAILED with exit code $TEST_EXIT_CODE"
          exit 1  # Fail the workflow step
        fi

    - name: Collect test artifacts
      if: always()
      run: |
        # Create artifact directory
        mkdir -p ${{ github.workspace }}/artifacts/${{ matrix.test_case }}
        
        # Copy logs if they exist
        if [ -d "test/auto-test/logs/${{ matrix.test_case }}" ]; then
          cp -r test/auto-test/logs/${{ matrix.test_case }}/* ${{ github.workspace }}/artifacts/${{ matrix.test_case }}/ || true
        fi
        
        # Copy test output
        if [ -f "test/auto-test/test_output.log" ]; then
          cp test/auto-test/test_output.log ${{ github.workspace }}/artifacts/${{ matrix.test_case }}/ || true
        fi
        
        # Copy result files
        if [ -f "test/auto-test/.result${{ matrix.test_case }}.txt" ]; then
          cp test/auto-test/.result${{ matrix.test_case }}.txt ${{ github.workspace }}/artifacts/${{ matrix.test_case }}/ || true
        fi
        
        # Create summary file
        echo "Test Case: ${{ matrix.test_case }}" > ${{ github.workspace }}/artifacts/${{ matrix.test_case }}/summary.txt
        echo "Result: ${TEST_RESULT:-UNKNOWN}" >> ${{ github.workspace }}/artifacts/${{ matrix.test_case }}/summary.txt
        echo "Execution Mode: ${{ github.event.inputs.execution_mode }}" >> ${{ github.workspace }}/artifacts/${{ matrix.test_case }}/summary.txt
        echo "Environment File: ${{ github.event.inputs.test_env_file }}" >> ${{ github.workspace }}/artifacts/${{ matrix.test_case }}/summary.txt
        echo "Timestamp: $(date)" >> ${{ github.workspace }}/artifacts/${{ matrix.test_case }}/summary.txt

    - name: Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ftc-test-results-${{ matrix.test_case }}
        path: artifacts/${{ matrix.test_case }}/
        retention-days: 30

    - name: Clean up Docker after test
      if: always()
      run: |
        # Comprehensive cleanup to free resources for next test
        echo "=== Cleaning up Docker environment ==="
        
        # Stop all containers
        docker ps -aq | xargs -r docker stop -t 10 || true
        docker ps -aq | xargs -r docker rm -f || true
        
        # Remove all networks (except default)
        docker network ls -q --filter type=custom | xargs -r docker network rm || true
        
        # Remove all volumes
        docker volume ls -q | xargs -r docker volume rm -f || true
        
        # Remove all images to free space
        docker images -q | xargs -r docker rmi -f || true
        
        # Final cleanup
        docker system prune -af --volumes || true
        
        # Clean up mounted directories that may have permission issues
        sudo rm -rf test/simulator-group/*/mnt 2>/dev/null || true
        sudo rm -f test/auto-test/logs/*/*.log 2>/dev/null || true
        
        # Show final state
        echo "=== Final Docker State ==="
        docker ps -a
        docker images
        df -h

  # Summary job that runs after all tests complete
  test-summary:
    needs: ftc-tests
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: all-results

    - name: Generate test summary
      run: |
        echo "# FTC Test Results Summary" > test_summary.md
        echo "" >> test_summary.md
        echo "**Execution Details:**" >> test_summary.md
        echo "- Environment File: ${{ github.event.inputs.test_env_file }}" >> test_summary.md
        echo "- Execution Mode: ${{ github.event.inputs.execution_mode }}" >> test_summary.md
        echo "- Timestamp: $(date)" >> test_summary.md
        echo "" >> test_summary.md
        echo "| Test Case | Result | Logs |" >> test_summary.md
        echo "|-----------|--------|------|" >> test_summary.md
        
        total_tests=0
        passed_tests=0
        failed_tests=0
        timeout_tests=0
        
        for dir in all-results/ftc-test-results-*/; do
          if [ -d "$dir" ]; then
            test_name=$(basename "$dir" | sed 's/ftc-test-results-//')
            total_tests=$((total_tests + 1))
            
            if [ -f "$dir/summary.txt" ]; then
              result=$(grep "Result:" "$dir/summary.txt" | cut -d' ' -f2)
              case "$result" in
                "PASS") passed_tests=$((passed_tests + 1)) ;;
                "FAIL") failed_tests=$((failed_tests + 1)) ;;
                "TIMEOUT") timeout_tests=$((timeout_tests + 1)) ;;
              esac
              echo "| $test_name | $result | [View Logs](all-results/ftc-test-results-$test_name/) |" >> test_summary.md
            else
              echo "| $test_name | UNKNOWN | [View Logs](all-results/ftc-test-results-$test_name/) |" >> test_summary.md
            fi
          fi
        done
        
        echo "" >> test_summary.md
        echo "**Summary Statistics:**" >> test_summary.md
        echo "- Total Tests: $total_tests" >> test_summary.md
        echo "- Passed: $passed_tests" >> test_summary.md
        echo "- Failed: $failed_tests" >> test_summary.md
        echo "- Timeout: $timeout_tests" >> test_summary.md
        echo "- Success Rate: $(( passed_tests * 100 / total_tests ))%" >> test_summary.md

    - name: Upload summary
      uses: actions/upload-artifact@v4
      with:
        name: test-summary
        path: test_summary.md

    - name: Comment PR or Issue (if applicable)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('test_summary.md', 'utf8');
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });
